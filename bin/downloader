#!/usr/bin/env python3

import sys 
import os
import csv
from downloader.lib import Downloader

if len(sys.argv) < 2:
    raise Exception('Downloads file and download dir required')

threads_count = int(sys.argv[3]) if len(sys.argv) == 4 else 20
download_to = os.path.realpath(sys.argv[2])
downloads_file = os.path.realpath(sys.argv[1])
outcsv = csv.writer(sys.stdout)

downloader = Downloader(download_to, threads_count)


def filter_empty(line):
    return line is not None


def parse_csv(columns):
    if len(columns) < 1:
        return None
    return columns[0]


with open(downloads_file, mode='r') as infile:
    reader = csv.reader(infile)
    for i in downloader.download_batch(filter(filter_empty, map(parse_csv, reader))):
        outcsv.writerow([i[0], i[1], i[3]])
        pass

